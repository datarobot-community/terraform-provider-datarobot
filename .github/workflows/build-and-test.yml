# Terraform Provider testing workflow.
name: Build and Test

# This GitHub action runs your tests for each pull request and push.
# Optionally, you can turn it on using a schedule for regular testing.
on:
  pull_request:
    paths-ignore:
      - 'README.md'
  push:
    paths-ignore:
      - 'README.md'

# Testing only needs permissions to read the repository contents.
permissions:
  contents: read

jobs:
  # Ensure project builds before running testing matrix
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - run: go build -v .
      - name: Run linters
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: latest
      - name: Check for large files
        run: |
          echo "Checking for files over 1MB..."
          find . -type f -size +1M -not -path './.git/*' -not -name '*.sum' | while read f; do
            echo "::warning file=$f::Large file detected: $(du -h "$f" | cut -f1)"
          done
      - name: Report tech debt (TODO/FIXME)
        run: |
          echo "## Tech Debt Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          count=$(grep -rn "TODO\|FIXME\|HACK\|BUG" --include="*.go" . | grep -v "_test.go" | wc -l | tr -d ' ')
          echo "Found **$count** TODO/FIXME/HACK/BUG comments in non-test code:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rn "TODO\|FIXME\|HACK\|BUG" --include="*.go" . | grep -v "_test.go" | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "::notice::Found $count tech debt markers (TODO/FIXME/HACK/BUG)"
      - name: Validate AGENTS.md commands
        run: |
          echo "## AGENTS.md Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check that documented commands work
          echo "Validating documented commands..." >> $GITHUB_STEP_SUMMARY
          
          # Test 'make build'
          if make build > /dev/null 2>&1; then
            echo "- [x] \`make build\` works" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] \`make build\` failed" >> $GITHUB_STEP_SUMMARY
            echo "::error::AGENTS.md documents 'make build' but it fails"
          fi
          
          # Test 'make lint'
          if make lint > /dev/null 2>&1; then
            echo "- [x] \`make lint\` works" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] \`make lint\` failed" >> $GITHUB_STEP_SUMMARY
            echo "::warning::AGENTS.md documents 'make lint' but it fails"
          fi
          
          # Test 'make generate'
          if make generate > /dev/null 2>&1; then
            echo "- [x] \`make generate\` works" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] \`make generate\` failed" >> $GITHUB_STEP_SUMMARY
            echo "::warning::AGENTS.md documents 'make generate' but it fails"
          fi
          
          # Verify AGENTS.md references valid Makefile targets
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Makefile targets referenced in AGENTS.md" >> $GITHUB_STEP_SUMMARY
          for target in build install lint test test-coverage testacc generate mocks; do
            if grep -q "make $target" AGENTS.md; then
              if grep -q "^$target:" Makefile; then
                echo "- [x] \`make $target\` exists in Makefile" >> $GITHUB_STEP_SUMMARY
              else
                echo "- [ ] \`make $target\` referenced but not in Makefile" >> $GITHUB_STEP_SUMMARY
                echo "::error::AGENTS.md references 'make $target' but target doesn't exist"
              fi
            fi
          done

  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'go.mod'
          cache: true
      # Temporarily download Terraform 1.8 prerelease for function documentation support.
      # When Terraform 1.8.0 final is released, this can be removed.
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: '1.8.0-alpha20240216'
          terraform_wrapper: false
      - run: go generate ./...
      - name: git diff
        run: |
          git diff --compact-summary --exit-code || \
            (echo; echo "Unexpected difference in directories after code generation. Run 'go generate ./...' command and commit."; exit 1)

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - name: Tests with coverage and timing
        run: |
          gotestsum --format testdox --junitfile test-results.xml \
            --rerun-fails --rerun-fails-max-failures=5 --packages="./..." -- \
            -v -cover -coverprofile=coverage.out -covermode=atomic \
            -timeout 5m -race
      - name: Report coverage
        run: |
          go tool cover -func=coverage.out | tail -1
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Total coverage: ${coverage}%"
          echo "::notice::Coverage is ${coverage}% (acceptance tests require DATAROBOT_API_TOKEN)"
      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: coverage.out
      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: test-results
          path: test-results.xml

  # Run acceptance tests in a matrix with Terraform CLI versions
  test:
    name: Terraform Provider Acceptance Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # list whatever Terraform versions here you would like to support
        terraform:
          - '1.0.*'
          - '1.1.*'
          - '1.2.*'
          - '1.3.*'
          - '1.4.*'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false
      - run: go mod download
      - env:
          TF_ACC: "1"
          DATAROBOT_API_TOKEN: ${{ secrets.DATAROBOT_API_KEY }}
        run: echo "integration tests disabled until we get a non-trial account"
        # uncomment to run the actual tests
        # run: go test -v -cover ./pkg/provider/
        timeout-minutes: 10
